
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload Rebar Blueprints</title>
</head>
<body>
  <h1>Upload Rebar Blueprints</h1>

  <input type="file" multiple id="fileInput" />
  <br />
  <label><input type="radio" name="mode" value="json" checked /> Extract Bar Table (JSON)</label><br />
  <label><input type="radio" name="mode" value="text" /> Generate Estimate Report (Text)</label><br />
  <button onclick="uploadAndParse()">Upload + Parse</button>

  <h3 id="filename"></h3>
  <pre id="output">...</pre>

  <script>
    async function uploadAndParse() {
      const fileInput = document.getElementById("fileInput");
      const files = fileInput.files;
      const output = document.getElementById("output");
      const filenameEl = document.getElementById("filename");

      output.textContent = "...";
      filenameEl.textContent = "";

      if (!files || files.length === 0) {
        alert("Please select a file.");
        return;
      }

      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        formData.append("files", files[i]);
      }

      const mode = document.querySelector("input[name='mode']:checked").value;
      const endpoint =
        mode === "json"
          ? "https://rebar-ai-backend.onrender.com/api/parse-blueprints"
          : "https://rebar-ai-backend.onrender.com/api/parse-blueprint-estimate";

      try {
        const uploadRes = await fetch("https://rebar-ai-backend.onrender.com/api/upload-blueprints", {
          method: "POST",
          body: formData,
        });

        if (!uploadRes.ok) throw new Error("Upload failed");
        const { filename, temp_path } = await uploadRes.json();
        filenameEl.textContent = filename;

        const parseRes = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ file_path: temp_path }),
        });

        const data = await parseRes.json();
        output.textContent = typeof data === "object"
          ? JSON.stringify(data, null, 2)
          : data;
      } catch (err) {
        console.error(err);
        output.textContent = "❌ Error: " + err.message;
      }
    }
  </script>
</body>
</html>
